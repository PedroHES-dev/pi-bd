<!DOCTYPE html>
<html lang="pt">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Controle de Estoque</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1a202c',
            secondary: '#4a5568',
          }
        }
      }
    };
  </script>
</head>

<body class="overflow-x-hidden">
  <div class="flex flex-col sm:flex-row h-screen">
    <!-- Menu Lateral -->
    <aside class="bg-primary text-white w-64 h-screen fixed top-0 left-0 p-6 hidden sm:block">
      <ul class="space-y-6">
        <!-- Dashboard -->
        <li class="flex items-center space-x-3">
          <span class="material-icons">dashboard</span>
          <a href="../index.html" class="block hover:text-gray-300">Dashboard</a>
        </li>
        <!-- Produtos -->
        <li class="flex items-center space-x-3">
          <span class="material-icons">inventory_2</span>
          <a href="#" class="block hover:text-gray-300">Produtos</a>
        </li>
        <!-- Gráficos -->
        <li class="flex items-center space-x-3">
          <span class="material-icons">bar_chart</span>
          <a href="#" class="block hover:text-gray-300">Gráficos</a>
        </li>
        <!-- Relatórios -->
        <li class="flex items-center space-x-3">
          <span class="material-icons">description</span>
          <a href="#" class="block hover:text-gray-300">Relatórios</a>
        </li>
        <!-- Configurações -->
        <li class="flex items-center space-x-3">
          <span class="material-icons">settings</span>
          <a href="#" class="block hover:text-gray-300">Configurações</a>
        </li>
        <!-- Sair -->
        <li class="absolute bottom-5 flex items-center space-x-3">
          <span class="material-icons">logout</span>
          <a href="#" class="block hover:text-gray-300">Sair</a>
        </li>
      </ul>
    </aside>

    <!-- Conteúdo Principal -->
    <main class="flex-grow sm:ml-64 bg-gray-100 pb-16 overflow-y-auto">
      <section class="p-6">
        <!-- Cadastrar Produto -->
        <section class="p-6 bg-white shadow-md rounded-lg mx-4 mt-6">
          <h2 class="text-2xl font-bold mb-4">Cadastrar Produto</h2>
          <form id="productForm" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-6">
            <div>
              <label for="image" class="block text-sm font-medium text-gray-700">Imagem</label>
              <input type="file" id="image"
                class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary bg-gray-100">
            </div>
            <div>
              <label for="name" class="block text-sm font-medium text-gray-700">Nome do Produto</label>
              <input type="text" id="name"
                class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary bg-gray-100">
            </div>
            <div>
              <label for="description" class="block text-sm font-medium text-gray-700">Descrição</label>
              <input type="text" id="description"
                class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary bg-gray-100">
            </div>
            <div>
              <label for="price" class="block text-sm font-medium text-gray-700">Preço</label>
              <input type="number" id="price"
                class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary bg-gray-100">
            </div>
            <div>
              <label for="quantity" class="block text-sm font-medium text-gray-700">Quantidade</label>
              <input type="number" id="quantity"
                class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary bg-gray-100">
            </div>
            <div>
              <label for="category" class="block text-sm font-medium text-gray-700">Fornecedor</label>
              <select id="category"
                class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary bg-gray-100">
                <option value="Categoria 1">Categoria 1</option>
                <option value="Categoria 2">Categoria 2</option>
                <option value="Categoria 3">Categoria 3</option>
                <option value="Categoria 4">Categoria 4</option>
              </select>
            </div>
          </form>
          <div class="flex justify-end">
            <button class="bg-primary text-white px-4 py-2 rounded hover:bg-primary/90">Cadastrar Produto</button>
          </div>
        </section>

        <!-- Produtos Cadastrados -->
        <section class="p-6">
          <h2 class="text-2xl font-bold mb-4">Produtos Cadastrados</h2>
          <!-- Barra de Pesquisa -->
          <div class="mb-4">
            <label for="searchInput" class="block text-sm font-medium text-gray-700">Pesquisar por Nome do
              Produto</label>
            <input type="text" id="searchInput"
              class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
          </div>

          <!-- Tabela (Desktop) -->
          <div class="hidden sm:block">
            <table class="table-auto w-full bg-white shadow-md rounded-lg">
              <thead class="bg-secondary text-white">
                <tr>
                  <th class="px-4 py-2">ID</th>
                  <th class="px-4 py-2">Nome</th>
                  <th class="px-4 py-2">Descrição</th>
                  <th class="px-4 py-2">Preço</th>
                  <th class="px-4 py-2">Quantidade</th>
                  <th class="px-4 py-2">Ações</th>
                </tr>
              </thead>
              <tbody id="productTableBody" class="text-gray-700">
                <!-- Dados dos produtos serão carregados aqui -->
              </tbody>
            </table>
          </div>

          <!-- Lista Responsiva (Mobile) -->
          <div id="responsiveProductList" class="block sm:hidden space-y-4">
            <!-- Produtos serão carregados dinamicamente -->
          </div>
        </section>
    </main>
  </div>

  <!-- Barra Inferior -->
  <div class="bg-primary text-white fixed bottom-0 left-0 w-full flex justify-around p-3 sm:hidden">
    <a href="../index.html" class="flex flex-col items-center hover:text-gray-300">
      <span class="material-icons">dashboard</span>
      <span class="text-xs">Dashboard</span>
    </a>
    <a href="#" class="flex flex-col items-center hover:text-gray-300">
      <span class="material-icons">inventory</span>
      <span class="text-xs">Produtos</span>
    </a>
    <a href="#" class="flex flex-col items-center hover:text-gray-300">
      <span class="material-icons">bar_chart</span>
      <span class="text-xs">Gráficos</span>
    </a>
    <a href="#" class="flex flex-col items-center hover:text-gray-300">
      <span class="material-icons">settings</span>
      <span class="text-xs">Configurações</span>
    </a>
    <a href="#" class="flex flex-col items-center hover:text-gray-300">
      <span class="material-icons">logout</span>
      <span class="text-xs">sair</span>
    </a>
  </div>
  </div>

  <!-- Modal de Edição -->
  <div id="editProductModal" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-75 hidden">
    <div class="bg-white p-8 rounded-xl shadow-2xl w-96 relative">
      <!-- Ícone de Fechar -->
      <button id="closeModal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition duration-200">
        <span class="material-icons">close</span>
      </button>

      <!-- Cabeçalho -->
      <h2 class="text-2xl font-extrabold text-gray-700 mb-6 border-b pb-2">Editar Produto</h2>

      <!-- Formulário -->
      <form id="editProductForm">
        <input type="hidden" id="editProductId">

        <!-- Nome -->
        <div class="mb-6">
          <label for="editProductName" class="block text-sm font-semibold text-gray-600 mb-1">Nome</label>
          <input type="text" id="editProductName"
            class="block w-full rounded-lg border-gray-300 shadow focus:ring-primary focus:border-primary px-4 py-2">
        </div>

        <!-- Descrição -->
        <div class="mb-6">
          <label for="editProductDescription" class="block text-sm font-semibold text-gray-600 mb-1">Descrição</label>
          <input type="text" id="editProductDescription"
            class="block w-full rounded-lg border-gray-300 shadow focus:ring-primary focus:border-primary px-4 py-2">
        </div>

        <!-- Preço -->
        <div class="mb-6">
          <label for="editProductPrice" class="block text-sm font-semibold text-gray-600 mb-1">Preço</label>
          <input type="number" id="editProductPrice" step="0.01"
            class="block w-full rounded-lg border-gray-300 shadow focus:ring-primary focus:border-primary px-4 py-2">
        </div>

        <!-- Quantidade -->
        <div class="mb-6">
          <label for="editProductQuantity" class="block text-sm font-semibold text-gray-600 mb-1">Quantidade</label>
          <input type="number" id="editProductQuantity"
            class="block w-full rounded-lg border-gray-300 shadow focus:ring-primary focus:border-primary px-4 py-2">
        </div>

        <!-- Botões -->
        <div class="flex justify-end">
          <button type="button" id="cancelButton"
            class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 hover:shadow transition">Cancelar</button>
          <button type="submit"
            class="ml-3 px-6 py-2 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 hover:shadow transition">Salvar</button>
        </div>
      </form>
    </div>
  </div>
</body>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function () {
    // Carregar produtos inicialmente
    loadProducts();

    function loadProducts(search = '', category = '', maxPrice = '', minQuantity = '') {
      $.ajax({
        url: `http://localhost:3000/api/produtos`,
        type: 'GET',
        data: {
          search: search,
          category: category,
          maxPrice: maxPrice,
          minQuantity: minQuantity
        },
        success: function (produtos) {
          let filteredProducts = produtos;

          // Filtragem adicional no Frontend (se necessário)
          filteredProducts = produtos.filter(produto => {
            return (!category || produto.categoria === category) &&
              (!maxPrice || produto.preco <= maxPrice) &&
              (!minQuantity || produto.quantidade_estoque >= minQuantity);
          });

          renderProducts(filteredProducts);
        }
      });
    }

    $(document).ready(function () {
      // Carregar produtos inicialmente
      loadProducts();

      // Eventos de filtro
      $('#filterCategory, #filterPrice, #filterQuantity').on('change input', function () {
        applyFilters();
      });

      $('#searchInput').on('input', function () {
        applyFilters();
      });

      function applyFilters() {
        const search = $('#searchInput').val();
        const category = $('#filterCategory').val();
        const maxPrice = $('#filterPrice').val();
        const minQuantity = $('#filterQuantity').val();

        loadProducts(search, category, maxPrice, minQuantity);
      }
    });

    // Carregar lista de produtos
    function loadProducts(searchValue = '') {
      $.ajax({
        url: `http://localhost:3000/api/produtos?search=${encodeURIComponent(searchValue)}`,
        type: "GET",
        success: function (produtos) {
          let tableRows = '';
          let responsiveList = '';

          produtos.forEach(produto => {
            let alert = '';
            if (produto.quantidade_estoque <= 20) {
              alert = `<span class="text-red-500 font-bold ml-2">Estoque baixo</span>`;
            }

            // Renderização para tabela (desktop)
            tableRows += `
          <tr class="hover:bg-gray-100">
            <td class="px-4 py-2 border">${produto.id_produto}</td>
            <td class="px-4 py-2 border">${produto.nome_produto}</td>
            <td class="px-4 py-2 border">${produto.descricao}</td>
            <td class="px-4 py-2 border">${produto.preco}</td>
            <td class="px-4 py-2 border">${produto.quantidade_estoque} ${alert}</td>
            <td class="px-4 py-2 border text-center">
              <button class="bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600 editBtn" 
                data-id="${produto.id_produto}" 
                data-produto='${JSON.stringify(produto)}'>Editar</button>
              <button class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 deleteBtn" 
                data-id="${produto.id_produto}">Excluir</button>
            </td>
          </tr>
        `;

            // Renderização para lista (mobile)
            responsiveList += `
          <div class="bg-white p-4 rounded shadow-md">
            <div class="mb-2">
              <strong>ID:</strong> ${produto.id_produto}
            </div>
            <div class="mb-2">
              <strong>Nome:</strong> ${produto.nome_produto}
            </div>
            <div class="mb-2">
              <strong>Descrição:</strong> ${produto.descricao}
            </div>
            <div class="mb-2">
              <strong>Preço:</strong> R$ ${produto.preco}
            </div>
            <div class="mb-2 flex justify-between items-center">
              <span><strong>Quantidade:</strong> ${produto.quantidade_estoque} ${alert}</span>
              <div class="space-x-2">
                <button class="bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600 editBtn" 
                  data-id="${produto.id_produto}" 
                  data-produto='${JSON.stringify(produto)}'>Editar</button>
                <button class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 deleteBtn" 
                  data-id="${produto.id_produto}">Excluir</button>
              </div>
            </div>
          </div>
        `;
          });

          // Renderizar tabela
          $('#productTableBody').html(tableRows);

          // Renderizar lista responsiva
          $('#responsiveProductList').html(responsiveList);
        },
        error: function () {
          console.error("Erro ao carregar produtos.");
        }
      });
    }


    // Abrir modal de edição e preencher com dados
    $(document).on('click', '.editBtn', function () {
      const produto = $(this).data('produto');

      // Preencher os campos do modal
      $('#editProductId').val(produto.id_produto);
      $('#editProductName').val(produto.nome_produto || '');
      $('#editProductDescription').val(produto.descricao || '');
      $('#editProductPrice').val(produto.preco || 0);
      $('#editProductQuantity').val(produto.quantidade_estoque || 0);

      // Exibir o modal
      $('#editProductModal').removeClass('hidden');
    });

    // Atualizar produto no banco de dados
    $('#editProductForm').on('submit', function (e) {
      e.preventDefault();

      const productId = $('#editProductId').val();
      const productName = $('#editProductName').val();
      const productDescription = $('#editProductDescription').val();
      const productPrice = $('#editProductPrice').val();
      const productQuantity = $('#editProductQuantity').val();

      if (!productName || !productDescription || !productPrice || !productQuantity) {
        alert('Todos os campos são obrigatórios.');
        return;
      }

      $.ajax({
        url: `http://localhost:3000/api/produto/${productId}`,
        type: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({
          nome_produto: productName,
          descricao: productDescription,
          preco: parseFloat(productPrice),
          quantidade_estoque: parseInt(productQuantity, 10),
        }),
        success: function () {
          alert('Produto atualizado com sucesso!');
          $('#editProductModal').addClass('hidden');
          loadProducts();
        },
        error: function () {
          alert('Erro ao atualizar o produto.');
        }
      });
    });

    // Excluir produto no banco de dados
    $(document).on('click', '.deleteBtn', function () {
      const productId = $(this).data('id');

      if (confirm('Você tem certeza que deseja excluir este produto?')) {
        $.ajax({
          url: `http://localhost:3000/api/produto/${productId}`,
          type: 'DELETE',
          success: function () {
            alert('Produto excluído com sucesso!');
            loadProducts();
          },
          error: function () {
            alert('Erro ao excluir o produto.');
          }
        });
      }
    });

    // Fechar o modal de edição
    $('#closeModal').on('click', function () {
      $('#editProductModal').addClass('hidden');
    });
  });
</script>

</body>

</html>